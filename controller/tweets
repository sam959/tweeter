const axios = require('axios');
const util = require('util');
var localTweets = require('./static/myTweets.json');

const getTweets = async (req, res) => {

  console.log(`received request ${util.inspect(req.userInfo)}`);

  const handle = req.userInfo.id;
  const baseUrl = `https://api.twitter.com/2/users/${handle}/tweets`;
  console.log(`received user id ${handle}`);

  if (!process.env.BEARER_TOKEN) {
    res.status(400).send("Error while authenticating call");
  }

  const token = process.env.BEARER_TOKEN;

  console.log(`sending request of tweets by id ${handle}`);

  const requestConfig = {
    url: baseUrl,
    auth: {
      bearer: token,
    }
  };

  console.log(`sending request ${requestConfig.url}`);

  const instance = axios.create({
    baseURL: requestConfig.url,
    timeout: 1000,
    headers: { 'Authorization': 'Bearer ' + process.env.BEARER_TOKEN }
  });

  instance.get(requestConfig.url)
    .then(function (response) {
      console.log(response.data);

      req.tweets = response.data
      res.render('tweeter', {rows : response.data})
    })
    .catch(function (error) {
      console.log(error);
      res.send(error);
    });

/*
  res.render('tweeter', {
    handle: req.userInfo.username,
    rows: req.data
  })
  */
};


const jsonTweets = async () => {
  console.log('getting tweets..')

  await delay(2000); // Delay 2s

  return localTweets;
};

module.exports = {
  getTweets
}